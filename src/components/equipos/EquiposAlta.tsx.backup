'use client';

import React, { useState, useEffect } from 'react';
import { useEquipos } from '@/hooks/useEquipos';
import { useCatalogos } from '@/hooks/useCatalogos';
import { useForm } from '@/hooks/useForm';
import CameraScanner from '@/components/ui/CameraScanner';
import ImageCapture from '@/components/ui/ImageCapture';
import { FormInput, FormSelect, FormTextArea } from '@/components/ui/FormComponents';
import AutoSaveForm, { FormStatus } from '@/components/ui/AutoSaveForm';
import MobileButton from '@/components/ui/MobileButton';

interface EquiposAltaProps {
  onSuccess?: () => void;
  onCancel?: () => void;
  enableAutoSave?: boolean;
}

export default function EquiposAlta({ onSuccess, onCancel, enableAutoSave = true }: EquiposAltaProps) {
  const { crearEquipo, loading } = useEquipos();
  const { tiposEquipo, sucursales, usuarios, estatusEquipo } = useCatalogos();
  
  // Estados para los componentes de cámara
  const [showScanner, setShowScanner] = useState<'serie' | 'activo' | null>(null);
  const [showImageCapture, setShowImageCapture] = useState(false);
  const [ubicacionImage, setUbicacionImage] = useState<{dataUrl: string, file: File} | null>(null);
  
  // Formulario con validación avanzada
  const {
    values,
    formState,
    formStatus,
    setFieldValue,
    setFieldTouched,
    validateForm,
    resetForm,
    handleSubmit,
    getFieldProps
  } = useForm({
    initialValues: {
      no_serie: '',
      nombreEquipo: '',
      modelo: '',
      numeroActivo: '',
      idTipoEquipo: '',
      idEstatus: '1', // Disponible por defecto
      idSucursal: '',
      idPosicion: '1', // Por defecto
      idUsuarios: '',
      valorEstimado: '',
      observaciones: '',
      imagen_ubicacion: '' // Nueva imagen de ubicación
    },
    validationRules: {
      no_serie: {
        required: true,
        minLength: 3,
        maxLength: 50,
        pattern: /^[A-Z0-9-]+$/i,
        custom: (value) => {
          if (value && !/^[A-Z0-9-]+$/i.test(value)) {
            return 'Solo se permiten letras, números y guiones';
          }
          return null;
        }
      },
      nombreEquipo: {
        required: true,
        minLength: 2,
        maxLength: 100
      },
      modelo: {
        maxLength: 50
      },
      numeroActivo: {
        maxLength: 20,
        pattern: /^[A-Z0-9-]*$/i
      },
      idTipoEquipo: {
        required: true
      },
      idEstatus: {
        required: true
      },
      idSucursal: {
        required: true
      },
      valorEstimado: {
        pattern: /^\d*\.?\d*$/,
        custom: (value) => {
          if (value && parseFloat(value) < 0) {
            return 'El valor debe ser positivo';
          }
          return null;
        }
      },
      observaciones: {
        maxLength: 500
      }
    },
    autoSave: enableAutoSave,
    autoSaveDelay: 3000,
    onAutoSave: async (data) => {
      // Auto-save a localStorage o servidor
      localStorage.setItem('equipos_alta_draft', JSON.stringify({
        ...data,
        timestamp: new Date().toISOString()
      }));
    },
    validateOnChange: true,
    validateOnBlur: true
  });

  const [mensaje, setMensaje] = useState<{tipo: 'success' | 'error', texto: string} | null>(null);

  // Cargar borrador al montar el componente
  React.useEffect(() => {
    const draft = localStorage.getItem('equipos_alta_draft');
    if (draft) {
      try {
        const parsedDraft = JSON.parse(draft);
        const { timestamp, ...draftData } = parsedDraft;
        
        // Solo cargar si es reciente (menos de 24 horas)
        const draftAge = new Date().getTime() - new Date(timestamp).getTime();
        if (draftAge < 24 * 60 * 60 * 1000) {
          Object.keys(draftData).forEach(key => {
            setFieldValue(key, draftData[key]);
          });
          setMensaje({
            tipo: 'success',
            texto: 'Se ha cargado un borrador guardado automáticamente'
          });
        }
      } catch (error) {
        console.error('Error cargando borrador:', error);
      }
    }
  }, [setFieldValue]);

  // Limpiar mensaje después de unos segundos
  React.useEffect(() => {
    if (mensaje) {
      const timer = setTimeout(() => setMensaje(null), 5000);
      return () => clearTimeout(timer);
    }
  }, [mensaje]);

  // Handlers para escáner y cámara
  const handleScanResult = (result: string, type: 'serie' | 'activo') => {
    if (type === 'serie') {
      setFieldValue('no_serie', result);
    } else if (type === 'activo') {
      setFieldValue('numeroActivo', result);
    }
    setShowScanner(null);
  };

  const handleImageCapture = (imageData: {dataUrl: string, file: File}) => {
    setUbicacionImage(imageData);
    setFieldValue('imagen_ubicacion', imageData.dataUrl);
    setShowImageCapture(false);
  };

  // Submit mejorado
  const onSubmit = handleSubmit(async (data) => {
    try {
      setMensaje(null);
      
      const equipoData = {
        ...data,
        valorEstimado: data.valorEstimado ? parseFloat(data.valorEstimado) : 0,
        imagen_ubicacion: ubicacionImage?.file
      };

      await crearEquipo(equipoData);
      
      // Limpiar borrador después del éxito
      localStorage.removeItem('equipos_alta_draft');
      
      setMensaje({
        tipo: 'success',
        texto: 'Equipo creado exitosamente'
      });

      // Reset form y llamar callback
      resetForm();
      setUbicacionImage(null);
      onSuccess?.();
      
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: error instanceof Error ? error.message : 'Error al crear el equipo'
      });
    }
  });

  const handleCancelWithConfirm = () => {
    if (formStatus.isDirty) {
      if (confirm('¿Estás seguro? Se perderán los cambios no guardados.')) {
        localStorage.removeItem('equipos_alta_draft');
        onCancel?.();
      }
    } else {
      onCancel?.();
    }
  };
    }

    if (!formData.nombreEquipo.trim()) {
      newErrors.nombreEquipo = 'El nombre del equipo es obligatorio';
    }

    if (!formData.modelo.trim()) {
      newErrors.modelo = 'El modelo es obligatorio';
    }

    if (!formData.idTipoEquipo) {
      newErrors.idTipoEquipo = 'El tipo de equipo es obligatorio';
    }

    if (!formData.idSucursal) {
      newErrors.idSucursal = 'La sucursal es obligatoria';
    }

    if (!formData.idUsuarios) {
      newErrors.idUsuarios = 'El usuario asignado es obligatorio';
    }

  // Preparar opciones para los selects
  const tipoEquipoOptions = tiposEquipo.map(tipo => ({
    value: tipo.idTipoEquipo?.toString() || '',
    label: tipo.nombre || ''
  }));

  const estatusOptions = estatusEquipo.map(estatus => ({
    value: estatus.idEstatus?.toString() || '',
    label: estatus.nombre || ''
  }));

  const sucursalOptions = sucursales.map(sucursal => ({
    value: sucursal.idCentro?.toString() || '',
    label: sucursal.nombre || ''
  }));

  const usuarioOptions = usuarios.map(usuario => ({
    value: usuario.idUsuarios?.toString() || '',
    label: usuario.NombreUsuario || ''
  }));

  const handleSubmit = async (data: any) => {
    try {
      const resultado = await fetch('/api/equipos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      if (resultado.ok) {
        onSuccess?.();
      } else {
        setMensaje({
          tipo: 'error',
          texto: 'Error al crear el equipo'
        });
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: 'Error al crear el equipo'
      });
    }
  };

  const handleCancel = () => {
    onCancel?.();
  };
  return (
    <AutoSaveForm 
      data={values}
      onSave={async (data) => {
        // Auto-save implementation ya está en el useForm
      }}
      showIndicator={enableAutoSave}
    >
      <div className="space-y-6">
        <div className="flex justify-between items-center">
          <div>
            <h1 className="text-2xl font-bold text-gray-900">Alta de Equipo</h1>
            <p className="text-gray-600">Registra un nuevo equipo en el inventario</p>
          </div>
        </div>

        {/* Form Status */}
        <FormStatus
          isDirty={formStatus.isDirty}
          isValid={formStatus.isValid}
          saveStatus={enableAutoSave ? 'saved' : 'idle'}
          validationErrors={{}}
        />

        {/* Mensaje de resultado */}
        {mensaje && (
          <div className={`rounded-md p-4 ${
            mensaje.tipo === 'success' 
              ? 'bg-green-50 border border-green-200 text-green-700' 
              : 'bg-red-50 border border-red-200 text-red-700'
          }`}>
            <div className="flex">
              <div className="flex-shrink-0">
                <i className={`fas ${mensaje.tipo === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}`}></i>
              </div>
              <div className="ml-3">
                <p className="text-sm">{mensaje.texto}</p>
              </div>
            </div>
          </div>
        )}

        <form onSubmit={onSubmit} className="bg-white rounded-lg shadow p-6">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Número de serie */}
            <div>
              <div className="flex space-x-2">
                <FormInput
                  label="Número de Serie"
                  required
                  placeholder="Ej: CAM-001-2024"
                  showCounter
                  maxLength={50}
                  {...getFieldProps('no_serie')}
                  rightIcon={
                    <button
                      type="button"
                      onClick={() => setShowScanner('serie')}
                      className="text-blue-500 hover:text-blue-700"
                      title="Escanear código"
                    >
                      <i className="fas fa-qrcode" />
                    </button>
                  }
                />
              </div>
            </div>

            {/* Nombre del equipo */}
            <FormInput
              label="Nombre del Equipo"
              required
              placeholder="Ej: Laptop Dell Inspiron"
              showCounter
              maxLength={100}
              {...getFieldProps('nombreEquipo')}
            />

            {/* Modelo */}
            <FormInput
              label="Modelo"
              placeholder="Ej: Inspiron 15 3000"
              showCounter
              maxLength={50}
              {...getFieldProps('modelo')}
            />

            {/* Número de activo */}
            <div>
              <div className="flex space-x-2">
                <FormInput
                  label="Número de Activo"
                  placeholder="Se genera automáticamente si se deja vacío"
                  showCounter
                  maxLength={20}
                  {...getFieldProps('numeroActivo')}
                  rightIcon={
                    <button
                      type="button"
                      onClick={() => setShowScanner('activo')}
                      className="text-blue-500 hover:text-blue-700"
                      title="Escanear código de activo"
                    >
                      <i className="fas fa-barcode" />
                    </button>
                  }
                />
              </div>
            </div>

            {/* Tipo de equipo */}
            <FormSelect
              label="Tipo de Equipo"
              required
              placeholder="Selecciona un tipo"
              options={tipoEquipoOptions}
              {...getFieldProps('idTipoEquipo')}
            />

            {/* Estado */}
            <FormSelect
              label="Estado"
              required
              options={estatusOptions}
              {...getFieldProps('idEstatus')}
            />

            {/* Sucursal */}
            <FormSelect
              label="Sucursal"
              required
              placeholder="Selecciona una sucursal"
              options={sucursalOptions}
              {...getFieldProps('idSucursal')}
            />

            {/* Usuario asignado */}
            <FormSelect
              label="Usuario Asignado"
              placeholder="Sin asignar"
              options={usuarioOptions}
              {...getFieldProps('idUsuarios')}
            />

            {/* Valor estimado */}
            <FormInput
              type="number"
              step="0.01"
              min="0"
              label="Valor Estimado"
              placeholder="0.00"
              leftIcon={<span className="text-gray-500">$</span>}
              {...getFieldProps('valorEstimado')}
            />
          </div>

          {/* Imagen de ubicación */}
          <div className="mt-6">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Imagen de Ubicación
            </label>
            
            {ubicacionImage ? (
              <div className="relative inline-block">
                <img 
                  src={ubicacionImage.dataUrl} 
                  alt="Ubicación del equipo" 
                  className="w-40 h-40 object-cover rounded-lg border border-gray-200"
                />
                <button
                  type="button"
                  onClick={() => setUbicacionImage(null)}
                  className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600"
                  title="Eliminar imagen"
                >
                  <i className="fas fa-times"></i>
                </button>
              </div>
            ) : (
              <button
                type="button"
                onClick={() => setShowImageCapture(true)}
                className="flex items-center justify-center w-40 h-40 border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400 transition-colors"
              >
                <div className="text-center">
                  <i className="fas fa-camera text-gray-400 text-2xl mb-2"></i>
                  <p className="text-sm text-gray-500">Tomar foto</p>
                </div>
              </button>
            )}
          </div>

          {/* Observaciones */}
          <div className="mt-6">
            <FormTextArea
              label="Observaciones"
              placeholder="Notas adicionales sobre el equipo..."
              autoResize
              showCounter
              maxLength={500}
              {...getFieldProps('observaciones')}
            />
          </div>

          {/* Botones */}
          <div className="mt-8 flex justify-end space-x-4">
            <MobileButton
              type="button"
              variant="outline"
              onClick={handleCancelWithConfirm}
              disabled={formStatus.isSubmitting}
            >
              Cancelar
            </MobileButton>
            
            <MobileButton
              type="submit"
              disabled={!formStatus.isValid || formStatus.isSubmitting}
              isLoading={formStatus.isSubmitting}
              rightIcon={<i className="fas fa-plus" />}
            >
              Crear Equipo
            </MobileButton>
          </div>
        </form>
      </div>
    </AutoSaveForm>
      {/* Componente de escaner de cámara */}
      {showScanner && (
        <CameraScanner
          mode="auto"
          onResult={(result, type) => handleScanResult(result, 'serie')}
          onClose={() => setShowScanner(null)}
          placeholder={showScanner === 'serie' ? 'Escanea el número de serie del equipo' : 'Escanea el número de activo del equipo'}
        />
      )}
      
      {/* Componente de captura de imagen */}
      {showImageCapture && (
        <ImageCapture
          onImageCapture={handleImageCapture}
          onClose={() => setShowImageCapture(false)}
          maxSizeMB={2}
          quality={0.8}
        />
      )}
    </AutoSaveForm>
  );
}
