module.exports=[23738,e=>{"use strict";e.s(["handler",()=>M,"patchFetch",()=>v,"routeModule",()=>O,"serverHooks",()=>m,"workAsyncStorage",()=>g,"workUnitAsyncStorage",()=>S],23738);var t=e.i(47909),a=e.i(74017),o=e.i(96250),r=e.i(59756),s=e.i(61916),i=e.i(69741),n=e.i(16795),l=e.i(87718),u=e.i(95169),c=e.i(47587),p=e.i(66012),d=e.i(70101),E=e.i(26937),R=e.i(10372),_=e.i(93695);e.i(52474);var A=e.i(220);e.s(["GET",()=>f,"POST",()=>N,"PUT",()=>C],53950);var T=e.i(89171),h=e.i(84168);async function f(e){try{let{searchParams:t}=new URL(e.url),a=t.get("estatus")||"ABIERTA",o=t.get("prioridad"),r=t.get("tipo"),s=t.get("tecnico"),i=t.get("fechaDesde"),n=t.get("fechaHasta"),l=t.get("sucursal"),u=[];try{let e=`
        SELECT 
          f.*,
          e.nombreEquipo,
          te.nombreTipo as tipoEquipo,
          COALESCE(s.Sucursal, 'Centro Principal') as sucursal,
          DATEDIFF(NOW(), f.fecha_reporte) as diasAbierta
        FROM fallas_equipos f
        INNER JOIN equipo e ON f.no_serie = e.no_serie
        LEFT JOIN tipoequipo te ON e.idTipoEquipo = te.idTipoEquipo
        LEFT JOIN posicionequipo pe ON e.idPosicion = pe.idPosicion
        LEFT JOIN sucursales s ON pe.idCentro = s.idCentro
        WHERE 1=1
      `,t=[];e+=" AND f.estatus = ?",t.push(a),o&&(e+=" AND f.prioridad = ?",t.push(o)),r&&(e+=" AND f.tipo_falla = ?",t.push(r)),s&&(e+=" AND f.tecnico_asignado LIKE ?",t.push(`%${s}%`)),i&&(e+=" AND f.fecha_reporte >= ?",t.push(i)),n&&(e+=" AND f.fecha_reporte <= ?",t.push(n)),l&&(e+=" AND s.Sucursal LIKE ?",t.push(`%${l}%`)),e+=" ORDER BY f.fecha_reporte DESC",u=await (0,h.executeQuery)(e,t)}catch(e){if(console.error("Error consultando fallas BD:",e),e instanceof Error&&e.message.includes("doesn't exist"))console.log("⚠️ Tabla fallas_equipos no existe. Crear con script SQL proporcionado."),u=[];else throw e}let c={total:u.length,abiertas:u.filter(e=>"ABIERTA"===e.estatus).length,en_proceso:u.filter(e=>"EN_PROCESO"===e.estatus).length,resueltas:u.filter(e=>"RESUELTA"===e.estatus).length,promedio_solucion_horas:0,por_tipo:{hardware:u.filter(e=>"HARDWARE"===e.tipo_falla).length,software:u.filter(e=>"SOFTWARE"===e.tipo_falla).length,conectividad:u.filter(e=>"CONECTIVIDAD"===e.tipo_falla).length,suministros:u.filter(e=>"SUMINISTROS"===e.tipo_falla).length,mecanica:u.filter(e=>"MECANICA"===e.tipo_falla).length,electrica:u.filter(e=>"ELECTRICA"===e.tipo_falla).length,otra:u.filter(e=>"OTRA"===e.tipo_falla).length},por_prioridad:{baja:u.filter(e=>"BAJA"===e.prioridad).length,normal:u.filter(e=>"NORMAL"===e.prioridad).length,alta:u.filter(e=>"ALTA"===e.prioridad).length,critica:u.filter(e=>"CRITICA"===e.prioridad).length},por_tecnico:[]},p=u.filter(e=>"RESUELTA"===e.estatus&&e.tiempo_solucion_horas);if(p.length>0){let e=p.reduce((e,t)=>e+(t.tiempo_solucion_horas||0),0);c.promedio_solucion_horas=Math.round(e/p.length*100)/100}let d=new Map;return u.forEach(e=>{if(e.tecnico_asignado){d.has(e.tecnico_asignado)||d.set(e.tecnico_asignado,{tecnico:e.tecnico_asignado,total_asignadas:0,resueltas:0,en_proceso:0,total_horas:0,promedio_horas:0});let t=d.get(e.tecnico_asignado);t.total_asignadas++,"RESUELTA"===e.estatus?(t.resueltas++,e.tiempo_solucion_horas&&(t.total_horas+=e.tiempo_solucion_horas)):"EN_PROCESO"===e.estatus&&t.en_proceso++}}),d.forEach(e=>{e.resueltas>0&&(e.promedio_horas=Math.round(e.total_horas/e.resueltas*100)/100),delete e.total_horas}),c.por_tecnico=Array.from(d.values()),T.NextResponse.json({success:!0,data:{fallas:u,estadisticas:c}})}catch(e){return console.error("Error consultando fallas:",e),T.NextResponse.json({success:!1,error:"Error interno del servidor"},{status:500})}}async function N(e){try{let{no_serie:t,tipo_falla:a,descripcion_problema:o,sintomas:r,prioridad:s="NORMAL",usuario_reporta:i,tecnico_asignado:n,ubicacion_falla:l,impacto:u="MEDIO",requiere_repuestos:c=!1,observaciones:p=""}=await e.json();if(!t||!a||!o||!i||!l)return T.NextResponse.json({success:!1,error:"Campos requeridos: no_serie, tipo_falla, descripcion_problema, usuario_reporta, ubicacion_falla"},{status:400});let d=await (0,h.executeQuery)("SELECT no_serie, nombreEquipo FROM equipo WHERE no_serie = ?",[t]);if(0===d.length)return T.NextResponse.json({success:!1,error:"Equipo no encontrado"},{status:404});let E=`
      CREATE TABLE IF NOT EXISTS fallas_equipos (
        id INT AUTO_INCREMENT PRIMARY KEY,
        no_serie VARCHAR(50) NOT NULL,
        tipo_falla ENUM('HARDWARE', 'SOFTWARE', 'CONECTIVIDAD', 'SUMINISTROS', 'MECANICA', 'ELECTRICA', 'OTRA') NOT NULL,
        descripcion_problema TEXT NOT NULL,
        sintomas TEXT,
        prioridad ENUM('BAJA', 'NORMAL', 'ALTA', 'CRITICA') DEFAULT 'NORMAL',
        usuario_reporta VARCHAR(100) NOT NULL,
        fecha_reporte TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        fecha_solucion TIMESTAMP NULL,
        tecnico_asignado VARCHAR(100),
        solucion_aplicada TEXT,
        estatus ENUM('ABIERTA', 'EN_PROCESO', 'RESUELTA', 'CANCELADA') DEFAULT 'ABIERTA',
        tiempo_solucion_horas DECIMAL(8,2),
        observaciones TEXT,
        ubicacion_falla VARCHAR(200) NOT NULL,
        impacto ENUM('BAJO', 'MEDIO', 'ALTO', 'CRITICO') DEFAULT 'MEDIO',
        requiere_repuestos BOOLEAN DEFAULT FALSE,
        repuestos_utilizados TEXT,
        costo_reparacion DECIMAL(10,2),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        INDEX idx_no_serie (no_serie),
        INDEX idx_estatus (estatus),
        INDEX idx_fecha_reporte (fecha_reporte),
        INDEX idx_tecnico (tecnico_asignado),
        FOREIGN KEY (no_serie) REFERENCES equipo(no_serie) ON UPDATE CASCADE
      )
    `;await (0,h.executeQuery)(E);let R=`
      INSERT INTO fallas_equipos (
        no_serie, tipo_falla, descripcion_problema, sintomas, prioridad,
        usuario_reporta, tecnico_asignado, ubicacion_falla, impacto,
        requiere_repuestos, observaciones
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `,_=await (0,h.executeQuery)(R,[t,a,o,r||"",s,i,n||null,l,u,+!!c,p]);return"CRITICA"===s||"CRITICO"===u?await (0,h.executeQuery)("UPDATE equipo SET EstatusEquipo = 'Fuera de Servicio' WHERE no_serie = ?",[t]):await (0,h.executeQuery)("UPDATE equipo SET EstatusEquipo = 'Con Falla' WHERE no_serie = ?",[t]),T.NextResponse.json({success:!0,message:"Falla registrada exitosamente",data:{fallaId:_.insertId,no_serie:t,tipo_falla:a,estatus:"ABIERTA"}})}catch(e){return console.error("Error creando falla:",e),T.NextResponse.json({success:!1,error:"Error interno del servidor"},{status:500})}}async function C(e){try{let{id:t,estatus:a,tecnico_asignado:o,solucion_aplicada:r,tiempo_solucion_horas:s,repuestos_utilizados:i,costo_reparacion:n,observaciones:l}=await e.json();if(!t)return T.NextResponse.json({success:!1,error:"ID de falla requerido"},{status:400});let u="UPDATE fallas_equipos SET updated_at = CURRENT_TIMESTAMP",c=[];if(a&&(u+=", estatus = ?",c.push(a),"RESUELTA"===a&&(u+=", fecha_solucion = CURRENT_TIMESTAMP")),void 0!==o&&(u+=", tecnico_asignado = ?",c.push(o),o&&"RESUELTA"!==a&&(u+=", estatus = 'EN_PROCESO'")),void 0!==r&&(u+=", solucion_aplicada = ?",c.push(r)),void 0!==s&&(u+=", tiempo_solucion_horas = ?",c.push(s)),void 0!==i&&(u+=", repuestos_utilizados = ?",c.push(i)),void 0!==n&&(u+=", costo_reparacion = ?",c.push(n)),void 0!==l&&(u+=", observaciones = ?",c.push(l)),u+=" WHERE id = ?",c.push(t),await (0,h.executeQuery)(u,c),"RESUELTA"===a){let e=await (0,h.executeQuery)("SELECT no_serie FROM fallas_equipos WHERE id = ?",[t]);if(e.length>0){let a=e[0].no_serie,o=`
          SELECT COUNT(*) as count 
          FROM fallas_equipos 
          WHERE no_serie = ? AND estatus IN ('ABIERTA', 'EN_PROCESO') AND id != ?
        `,r=await (0,h.executeQuery)(o,[a,t]);0===r[0].count&&await (0,h.executeQuery)("UPDATE equipo SET EstatusEquipo = 'Activo' WHERE no_serie = ?",[a])}}return T.NextResponse.json({success:!0,message:"Falla actualizada exitosamente"})}catch(e){return console.error("Error actualizando falla:",e),T.NextResponse.json({success:!1,error:"Error interno del servidor"},{status:500})}}var I=e.i(53950);let O=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/equipos/fallas/route",pathname:"/api/equipos/fallas",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/equipos/fallas/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:g,workUnitAsyncStorage:S,serverHooks:m}=O;function v(){return(0,o.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:S})}async function M(e,t,o){var T;let h="/api/equipos/fallas/route";h=h.replace(/\/index$/,"")||"/";let f=await O.prepare(e,t,{srcPage:h,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:N,params:C,nextConfig:I,isDraftMode:g,prerenderManifest:S,routerServerContext:m,isOnDemandRevalidate:v,revalidateOnlyGenerated:M,resolvedPathname:x}=f,L=(0,i.normalizeAppPath)(h),U=!!(S.dynamicRoutes[L]||S.routes[x]);if(U&&!g){let e=!!S.routes[x],t=S.dynamicRoutes[L];if(t&&!1===t.fallback&&!e)throw new _.NoFallbackError}let D=null;!U||O.isDev||g||(D="/index"===(D=x)?"/":D);let w=!0===O.isDev||!U,P=U&&!w,q=e.method||"GET",y=(0,s.getTracer)(),b=y.getActiveScopeSpan(),F={params:C,prerenderManifest:S,renderOpts:{experimental:{cacheComponents:!!I.experimental.cacheComponents,authInterrupts:!!I.experimental.authInterrupts},supportsDynamicResponse:w,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(T=I.experimental)?void 0:T.cacheLife,isRevalidate:P,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,o)=>O.onRequestError(e,t,o,m)},sharedContext:{buildId:N}},H=new n.NodeNextRequest(e),j=new n.NodeNextResponse(t),B=l.NextRequestAdapter.fromNodeNextRequest(H,(0,l.signalFromNodeResponse)(t));try{let i=async a=>O.handle(B,F).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let o=y.getRootSpanAttributes();if(!o)return;if(o.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${o.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=o.get("next.route");if(r){let e=`${q} ${r}`;a.setAttributes({"next.route":r,"http.route":r,"next.span_name":e}),a.updateName(e)}else a.updateName(`${q} ${e.url}`)}),n=async s=>{var n,l;let u=async({previousCacheEntry:a})=>{try{if(!(0,r.getRequestMeta)(e,"minimalMode")&&v&&M&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(s);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&o.waitUntil&&(o.waitUntil(l),l=void 0);let u=F.renderOpts.collectedTags;if(!U)return await (0,p.sendResponse)(H,j,n,F.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,d.toNodeOutgoingHttpHeaders)(n.headers);u&&(t[R.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,o=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:A.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:o}}}}catch(t){throw(null==a?void 0:a.isStale)&&await O.onRequestError(e,t,{routerKind:"App Router",routePath:h,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:P,isOnDemandRevalidate:v})},m),t}},_=await O.handleResponse({req:e,nextConfig:I,cacheKey:D,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:v,revalidateOnlyGenerated:M,responseGenerator:u,waitUntil:o.waitUntil});if(!U)return null;if((null==_||null==(n=_.value)?void 0:n.kind)!==A.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==_||null==(l=_.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,r.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",v?"REVALIDATED":_.isMiss?"MISS":_.isStale?"STALE":"HIT"),g&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let T=(0,d.fromNodeOutgoingHttpHeaders)(_.value.headers);return(0,r.getRequestMeta)(e,"minimalMode")&&U||T.delete(R.NEXT_CACHE_TAGS_HEADER),!_.cacheControl||t.getHeader("Cache-Control")||T.get("Cache-Control")||T.set("Cache-Control",(0,E.getCacheControlHeader)(_.cacheControl)),await (0,p.sendResponse)(H,j,new Response(_.value.body,{headers:T,status:_.value.status||200})),null};b?await n(b):await y.withPropagatedContext(e.headers,()=>y.trace(u.BaseServerSpan.handleRequest,{spanName:`${q} ${e.url}`,kind:s.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},n))}catch(t){if(t instanceof _.NoFallbackError||await O.onRequestError(e,t,{routerKind:"App Router",routePath:L,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:P,isOnDemandRevalidate:v})}),U)throw t;return await (0,p.sendResponse)(H,j,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_9201eedf.js.map