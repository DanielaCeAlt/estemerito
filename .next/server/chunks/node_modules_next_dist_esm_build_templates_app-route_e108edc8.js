module.exports=[7032,e=>{"use strict";e.s(["handler",()=>_,"patchFetch",()=>y,"routeModule",()=>q,"serverHooks",()=>M,"workAsyncStorage",()=>H,"workUnitAsyncStorage",()=>U],7032);var t=e.i(47909),i=e.i(74017),o=e.i(96250),n=e.i(59756),a=e.i(61916),s=e.i(69741),r=e.i(16795),u=e.i(87718),l=e.i(95169),E=e.i(47587),c=e.i(66012),N=e.i(70101),d=e.i(26937),m=e.i(10372),p=e.i(93695);e.i(52474);var O=e.i(220);e.s(["GET",()=>T],67428);var A=e.i(89171),R=e.i(84168);async function T(e){try{let t,{searchParams:i}=new URL(e.url),o=i.get("tipo"),n=i.get("sucursal"),a=i.get("fechaDesde"),s=i.get("fechaHasta"),r=i.get("formato")||"json";if(!o)return A.NextResponse.json({success:!1,error:"Tipo de reporte es requerido"},{status:400});switch(o){case"inventario-completo":t=await S(n);break;case"equipos-por-estatus":t=await I(n);break;case"movimientos-frecuentes":t=await h(a,s,n);break;case"mantenimientos-pendientes":t=await D(n);break;case"utilizacion-equipos":t=await f(a,s,n);break;case"equipos-obsoletos":t=await C(n);break;case"costo-mantenimiento":t=await v(a,s,n);break;case"eficiencia-sucursales":t=await b(a,s);break;default:return A.NextResponse.json({success:!1,error:"Tipo de reporte no válido"},{status:400})}if("csv"===r){let e=function(e){if(!e||0===e.length)return"";let t=Object.keys(e[0]);return[t.join(","),...e.map(e=>t.map(t=>{let i=e[t];return"string"==typeof i&&i.includes(",")?`"${i}"`:i}).join(","))].join("\n")}(t.equipos||t.datos||[]);return new A.NextResponse(e,{headers:{"Content-Type":"text/csv","Content-Disposition":`attachment; filename="${o}-${new Date().toISOString().split("T")[0]}.csv"`}})}return A.NextResponse.json({success:!0,data:t,tipoReporte:o,generadoEn:new Date().toISOString(),parametros:{sucursal:n,fechaDesde:a,fechaHasta:s,formato:r}},{status:200})}catch(e){return console.error("Error generando reporte:",e),A.NextResponse.json({success:!1,error:"Error interno del servidor"},{status:500})}}async function S(e){let t="",i=[];e&&(t="WHERE s.id = ?",i.push(e));let o=`
    SELECT 
      e.no_serie,
      e.nombreEquipo,
      e.modelo,
      e.numeroActivo,
      e.fechaAlta,
      te.nombre AS tipoEquipo,
      ee.nombre AS estatus,
      s.nombre AS sucursal,
      l.nombre AS area,
      z.nombre AS zona,
      est.nombre AS estado,
      m.nombre AS municipio,
      u.nombre AS responsable,
      DATEDIFF(CURDATE(), e.fechaAlta) AS diasEnSistema,
      -- Valor estimado basado en tipo de equipo
      CASE te.nombre
        WHEN 'NVR' THEN 15000
        WHEN 'DVR' THEN 8000
        WHEN 'Camara PTZ' THEN 12000
        WHEN 'Camara 360' THEN 6000
        WHEN 'Camara Domo' THEN 4000
        WHEN 'Switch' THEN 3000
        ELSE 1000
      END AS valorEstimado
    FROM equipo e
    INNER JOIN tipoequipo te ON e.idTipoEquipo = te.id
    INNER JOIN estatusequipo ee ON e.idEstatus = ee.id
    INNER JOIN usuarios u ON e.idUsuarios = u.id
    INNER JOIN layout l ON e.idLayout = l.id
    INNER JOIN sucursales s ON l.centro = s.id
    INNER JOIN zonas z ON s.zona = z.id
    INNER JOIN estados est ON s.estado = est.id
    INNER JOIN municipios m ON s.municipio = m.id
    ${t}
    ORDER BY s.nombre, te.nombre, e.nombreEquipo
  `,n=await (0,R.executeQuery)(o,i);return{resumen:{totalEquipos:n.length,valorTotalEstimado:n.reduce((e,t)=>e+(t.valorEstimado||0),0),porEstatus:n.reduce((e,t)=>{let i=String(t.estatus||"Sin Estado");return e[i]=(e[i]||0)+1,e},{}),porTipo:n.reduce((e,t)=>{let i=String(t.tipoEquipo||"Sin Tipo");return e[i]=(e[i]||0)+1,e},{}),porSucursal:n.reduce((e,t)=>{let i=String(t.sucursal||"Sin Sucursal");return e[i]=(e[i]||0)+1,e},{})},equipos:n,metadatos:{tipoReporte:"inventario-completo",filtros:{sucursal:e}}}}async function I(e){let t="",i=[];e&&(t="WHERE s.id = ?",i.push(e));let o=`
    SELECT 
      ee.nombre AS estatus,
      te.nombre AS tipoEquipo,
      s.nombre AS sucursal,
      COUNT(*) AS cantidad,
      GROUP_CONCAT(e.no_serie SEPARATOR ', ') AS equipos,
      AVG(DATEDIFF(CURDATE(), e.fechaAlta)) AS promedioDiasEnEstatus
    FROM equipo e
    INNER JOIN tipoequipo te ON e.idTipoEquipo = te.id
    INNER JOIN estatusequipo ee ON e.idEstatus = ee.id
    INNER JOIN layout l ON e.idLayout = l.id
    INNER JOIN sucursales s ON l.centro = s.id
    ${t}
    GROUP BY ee.nombre, te.nombre, s.nombre
    ORDER BY ee.nombre, cantidad DESC
  `,n=await (0,R.executeQuery)(o,i);return{datos:n,resumen:{totalCombinaciones:n.length,estatusUnicos:[...new Set(n.map(e=>e.estatus))],tiposUnicos:[...new Set(n.map(e=>e.tipoEquipo))]}}}async function h(e,t,i){let o=[],n=[];e&&(o.push("DATE(mi.fecha) >= ?"),n.push(e)),t&&(o.push("DATE(mi.fecha) <= ?"),n.push(t)),i&&(o.push("(mi.origen_idCentro = ? OR mi.destino_idCentro = ?)"),n.push(i,i));let a=o.length>0?`WHERE ${o.join(" AND ")}`:"",s=`
    SELECT 
      e.no_serie,
      e.nombreEquipo,
      COUNT(mi.id) AS totalMovimientos,
      tm.nombre AS tipoMovimientoMasFrecuente,
      MAX(mi.fecha) AS ultimoMovimiento,
      AVG(CASE 
        WHEN mi.fechaFin IS NOT NULL 
        THEN DATEDIFF(mi.fechaFin, mi.fecha)
        ELSE NULL
      END) AS promedioDuracionMovimientos
    FROM equipo e
    LEFT JOIN movimientoinventario mi ON e.no_serie = mi.no_serie
    LEFT JOIN tipomovimiento tm ON mi.idTipoMov = tm.id
    ${a}
    GROUP BY e.no_serie, e.nombreEquipo
    HAVING totalMovimientos > 0
    ORDER BY totalMovimientos DESC
    LIMIT 50
  `,r=await (0,R.executeQuery)(s,n);return{equiposConMovimientos:r,resumen:{equiposAnalizados:r.length,totalMovimientos:r.reduce((e,t)=>e+(t.totalMovimientos||0),0),promedioMovimientosPorEquipo:r.length>0?r.reduce((e,t)=>e+(t.totalMovimientos||0),0)/r.length:0}}}async function D(e){let t=['tm.nombre = "MANTENIMIENTO"','em.nombre = "ABIERTO"'],i=[];e&&(t.push("s.id = ?"),i.push(e));let o=`
    SELECT 
      mi.id AS idMantenimiento,
      e.no_serie,
      e.nombreEquipo,
      te.nombre AS tipoEquipo,
      mi.fecha AS fechaProgramada,
      mi.tipo_mantenimiento,
      mi.prioridad_mantenimiento,
      mi.estimacion_horas,
      u.nombre AS tecnicoAsignado,
      s.nombre AS sucursal,
      l.nombre AS area,
      DATEDIFF(CURDATE(), mi.fecha) AS diasVencido,
      CASE 
        WHEN DATEDIFF(CURDATE(), mi.fecha) > 7 THEN 'URGENTE'
        WHEN DATEDIFF(CURDATE(), mi.fecha) > 3 THEN 'ATRASADO'
        WHEN DATEDIFF(CURDATE(), mi.fecha) > 0 THEN 'VENCIDO'
        ELSE 'EN_TIEMPO'
      END AS estadoVencimiento
    FROM movimientoinventario mi
    INNER JOIN tipomovimiento tm ON mi.idTipoMov = tm.id
    INNER JOIN estatusmovimiento em ON mi.idEstatusMov = em.id
    INNER JOIN equipo e ON mi.no_serie = e.no_serie
    INNER JOIN tipoequipo te ON e.idTipoEquipo = te.id
    INNER JOIN usuarios u ON mi.idUsuarios = u.id
    INNER JOIN layout l ON e.idLayout = l.id
    INNER JOIN sucursales s ON l.centro = s.id
    WHERE ${t.join(" AND ")}
    ORDER BY diasVencido DESC, mi.prioridad_mantenimiento
  `,n=await (0,R.executeQuery)(o,i);return{mantenimientosPendientes:n,resumen:{total:n.length,urgentes:n.filter(e=>"URGENTE"===e.estadoVencimiento).length,atrasados:n.filter(e=>"ATRASADO"===e.estadoVencimiento).length,vencidos:n.filter(e=>"VENCIDO"===e.estadoVencimiento).length,enTiempo:n.filter(e=>"EN_TIEMPO"===e.estadoVencimiento).length}}}async function f(e,t,i){let o=await (0,R.executeQuery)(`
    SELECT 
      e.no_serie,
      e.nombreEquipo,
      te.nombre AS tipoEquipo,
      ee.nombre AS estatusActual,
      s.nombre AS sucursal,
      COUNT(mi.id) AS totalMovimientos,
      CASE ee.nombre
        WHEN 'En uso' THEN 100
        WHEN 'Disponible' THEN 50
        WHEN 'Mantenimiento' THEN 0
        WHEN 'Da\xf1ado' THEN 0
        ELSE 25
      END AS porcentajeUtilizacion
    FROM equipo e
    INNER JOIN tipoequipo te ON e.idTipoEquipo = te.id
    INNER JOIN estatusequipo ee ON e.idEstatus = ee.id
    INNER JOIN layout l ON e.idLayout = l.id
    INNER JOIN sucursales s ON l.centro = s.id
    LEFT JOIN movimientoinventario mi ON e.no_serie = mi.no_serie
    ${i?"WHERE s.id = ?":""}
    GROUP BY e.no_serie
    ORDER BY porcentajeUtilizacion DESC
  `,i?[i]:[]);return{equipos:o,resumen:{utilizacionPromedio:o.reduce((e,t)=>e+(t.porcentajeUtilizacion||0),0)/o.length,equiposEnUso:o.filter(e=>"En uso"===String(e.estatusActual)).length,equiposDisponibles:o.filter(e=>"Disponible"===String(e.estatusActual)).length,equiposInactivos:o.filter(e=>["Mantenimiento","Dañado","Baja"].includes(String(e.estatusActual))).length}}}async function C(e){let t=`
    SELECT 
      e.no_serie,
      e.nombreEquipo,
      e.modelo,
      te.nombre AS tipoEquipo,
      e.fechaAlta,
      DATEDIFF(CURDATE(), e.fechaAlta) AS diasEnSistema,
      s.nombre AS sucursal,
      COUNT(mi.id) AS totalMovimientos,
      MAX(mi.fecha) AS ultimoMovimiento,
      CASE 
        WHEN DATEDIFF(CURDATE(), e.fechaAlta) > 1825 THEN 'OBSOLETO' -- 5 a\xf1os
        WHEN DATEDIFF(CURDATE(), e.fechaAlta) > 1095 THEN 'ANTIGUO' -- 3 a\xf1os
        WHEN DATEDIFF(CURDATE(), e.fechaAlta) > 730 THEN 'MADURO' -- 2 a\xf1os
        ELSE 'NUEVO'
      END AS categoriaEdad
    FROM equipo e
    INNER JOIN tipoequipo te ON e.idTipoEquipo = te.id
    INNER JOIN layout l ON e.idLayout = l.id
    INNER JOIN sucursales s ON l.centro = s.id
    LEFT JOIN movimientoinventario mi ON e.no_serie = mi.no_serie
    ${e?"WHERE s.id = ?":""}
    GROUP BY e.no_serie
    HAVING categoriaEdad IN ('OBSOLETO', 'ANTIGUO')
    ORDER BY diasEnSistema DESC
  `,i=await (0,R.executeQuery)(t,e?[e]:[]);return{equiposObsoletos:i,resumen:{total:i.length,obsoletos:i.filter(e=>"OBSOLETO"===e.categoriaEdad).length,antiguos:i.filter(e=>"ANTIGUO"===e.categoriaEdad).length,recomendacionesReemplazo:i.filter(e=>"OBSOLETO"===e.categoriaEdad).length}}}async function v(e,t,i){let o=await (0,R.executeQuery)(`
    SELECT 
      s.nombre AS sucursal,
      te.nombre AS tipoEquipo,
      mi.tipo_mantenimiento,
      COUNT(*) AS cantidadMantenimientos,
      SUM(mi.estimacion_horas) AS totalHorasEstimadas,
      SUM(mi.estimacion_horas * 350) AS costoEstimado -- $350 por hora t\xe9cnico
    FROM movimientoinventario mi
    INNER JOIN tipomovimiento tm ON mi.idTipoMov = tm.id
    INNER JOIN equipo e ON mi.no_serie = e.no_serie
    INNER JOIN tipoequipo te ON e.idTipoEquipo = te.id
    INNER JOIN layout l ON e.idLayout = l.id
    INNER JOIN sucursales s ON l.centro = s.id
    WHERE tm.nombre = 'MANTENIMIENTO'
    ${e?"AND DATE(mi.fecha) >= ?":""}
    ${t?"AND DATE(mi.fecha) <= ?":""}
    ${i?"AND s.id = ?":""}
    GROUP BY s.nombre, te.nombre, mi.tipo_mantenimiento
    ORDER BY costoEstimado DESC
  `,[e,t,i].filter(Boolean));return{costos:o,resumen:{costoTotal:o.reduce((e,t)=>e+(t.costoEstimado||0),0),horasTotales:o.reduce((e,t)=>e+(t.totalHorasEstimadas||0),0),mantenimientosTotales:o.reduce((e,t)=>e+(t.cantidadMantenimientos||0),0)}}}async function b(e,t){let i=await (0,R.executeQuery)(`
    SELECT 
      s.nombre AS sucursal,
      z.nombre AS zona,
      COUNT(DISTINCT e.no_serie) AS totalEquipos,
      COUNT(DISTINCT CASE WHEN ee.nombre = 'En uso' THEN e.no_serie END) AS equiposEnUso,
      COUNT(DISTINCT CASE WHEN ee.nombre = 'Disponible' THEN e.no_serie END) AS equiposDisponibles,
      COUNT(DISTINCT CASE WHEN ee.nombre = 'Mantenimiento' THEN e.no_serie END) AS equiposEnMantenimiento,
      COUNT(mi.id) AS totalMovimientos,
      AVG(CASE 
        WHEN mi.fechaFin IS NOT NULL 
        THEN DATEDIFF(mi.fechaFin, mi.fecha)
        ELSE NULL
      END) AS promedioDuracionMovimientos,
      (COUNT(DISTINCT CASE WHEN ee.nombre = 'En uso' THEN e.no_serie END) * 100.0 / COUNT(DISTINCT e.no_serie)) AS porcentajeUtilizacion
    FROM sucursales s
    INNER JOIN zonas z ON s.zona = z.id
    INNER JOIN layout l ON s.id = l.centro
    INNER JOIN equipo e ON l.id = e.idLayout
    INNER JOIN estatusequipo ee ON e.idEstatus = ee.id
    LEFT JOIN movimientoinventario mi ON e.no_serie = mi.no_serie
    ${e||t?"WHERE":""}
    ${e?"DATE(mi.fecha) >= ?":""}
    ${e&&t?"AND":""}
    ${t?"DATE(mi.fecha) <= ?":""}
    GROUP BY s.id, s.nombre, z.nombre
    ORDER BY porcentajeUtilizacion DESC
  `,[e,t].filter(Boolean));return{eficiencia:i,resumen:{sucursalMasEficiente:i[0]?.sucursal||"N/A",promedioUtilizacion:i.length>0?i.reduce((e,t)=>e+(t.porcentajeUtilizacion||0),0)/i.length:0}}}var g=e.i(67428);let q=new t.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/equipos/reports/route",pathname:"/api/equipos/reports",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/equipos/reports/route.ts",nextConfigOutput:"",userland:g}),{workAsyncStorage:H,workUnitAsyncStorage:U,serverHooks:M}=q;function y(){return(0,o.patchFetch)({workAsyncStorage:H,workUnitAsyncStorage:U})}async function _(e,t,o){var A;let R="/api/equipos/reports/route";R=R.replace(/\/index$/,"")||"/";let T=await q.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!T)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:S,params:I,nextConfig:h,isDraftMode:D,prerenderManifest:f,routerServerContext:C,isOnDemandRevalidate:v,revalidateOnlyGenerated:b,resolvedPathname:g}=T,H=(0,s.normalizeAppPath)(R),U=!!(f.dynamicRoutes[H]||f.routes[g]);if(U&&!D){let e=!!f.routes[g],t=f.dynamicRoutes[H];if(t&&!1===t.fallback&&!e)throw new p.NoFallbackError}let M=null;!U||q.isDev||D||(M="/index"===(M=g)?"/":M);let y=!0===q.isDev||!U,_=U&&!y,w=e.method||"GET",x=(0,a.getTracer)(),F=x.getActiveScopeSpan(),L={params:I,prerenderManifest:f,renderOpts:{experimental:{cacheComponents:!!h.experimental.cacheComponents,authInterrupts:!!h.experimental.authInterrupts},supportsDynamicResponse:y,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(A=h.experimental)?void 0:A.cacheLife,isRevalidate:_,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,o)=>q.onRequestError(e,t,o,C)},sharedContext:{buildId:S}},J=new r.NodeNextRequest(e),P=new r.NodeNextResponse(t),W=u.NextRequestAdapter.fromNodeNextRequest(J,(0,u.signalFromNodeResponse)(t));try{let s=async i=>q.handle(W,L).finally(()=>{if(!i)return;i.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let o=x.getRootSpanAttributes();if(!o)return;if(o.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${o.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=o.get("next.route");if(n){let e=`${w} ${n}`;i.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),i.updateName(e)}else i.updateName(`${w} ${e.url}`)}),r=async a=>{var r,u;let l=async({previousCacheEntry:i})=>{try{if(!(0,n.getRequestMeta)(e,"minimalMode")&&v&&b&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await s(a);e.fetchMetrics=L.renderOpts.fetchMetrics;let u=L.renderOpts.pendingWaitUntil;u&&o.waitUntil&&(o.waitUntil(u),u=void 0);let l=L.renderOpts.collectedTags;if(!U)return await (0,c.sendResponse)(J,P,r,L.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,N.toNodeOutgoingHttpHeaders)(r.headers);l&&(t[m.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,o=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:O.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:o}}}}catch(t){throw(null==i?void 0:i.isStale)&&await q.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,E.getRevalidateReason)({isRevalidate:_,isOnDemandRevalidate:v})},C),t}},p=await q.handleResponse({req:e,nextConfig:h,cacheKey:M,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:f,isRoutePPREnabled:!1,isOnDemandRevalidate:v,revalidateOnlyGenerated:b,responseGenerator:l,waitUntil:o.waitUntil});if(!U)return null;if((null==p||null==(r=p.value)?void 0:r.kind)!==O.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(u=p.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,n.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",v?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),D&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let A=(0,N.fromNodeOutgoingHttpHeaders)(p.value.headers);return(0,n.getRequestMeta)(e,"minimalMode")&&U||A.delete(m.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||A.get("Cache-Control")||A.set("Cache-Control",(0,d.getCacheControlHeader)(p.cacheControl)),await (0,c.sendResponse)(J,P,new Response(p.value.body,{headers:A,status:p.value.status||200})),null};F?await r(F):await x.withPropagatedContext(e.headers,()=>x.trace(l.BaseServerSpan.handleRequest,{spanName:`${w} ${e.url}`,kind:a.SpanKind.SERVER,attributes:{"http.method":w,"http.target":e.url}},r))}catch(t){if(t instanceof p.NoFallbackError||await q.onRequestError(e,t,{routerKind:"App Router",routePath:H,routeType:"route",revalidateReason:(0,E.getRevalidateReason)({isRevalidate:_,isOnDemandRevalidate:v})}),U)throw t;return await (0,c.sendResponse)(J,P,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_e108edc8.js.map